<!DOCTYPE html>
<head>
    <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
    <meta charset="utf-8">
    <title>Visual Encoding App</title>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <!--<script src="http://localhost:3000/bundle.js"></script>-->
    <!--<script data-main="main.js" src="require.js"></script>-->
    <script src="cytoscape.js"></script>
    <!--<script src="http://localhost:3000/bundle.js"></script>-->
    <!--<script src="node_modules/cytoscape/src/index.js"></script>-->
    <!--<script src="node_modules/jquery/src/jquery.js"></script>-->
    <!--<script src="node_modules/d3/d3.min.js"></script>-->
    <style>
        #cy {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0px;
            left: 0px;
            display: none;
        }
    </style>
</head>
<div id="rankTableSection">
    <input id="numEncodings">
    <input id="numTasks">
    <button id="updateTableDim" onclick="updateTableDimensions()">update table</button>
    <button id="randvalues" onclick="randomRanks()">generate random ranks</button>
    <button id="sendranktable" onclick="sendToR()">send table</button>
    <button id="visualizeNetwork" onclick="plotNetwork()">visualize</button>
</div>
<div id="uploadGraphSection">
    <div id="dvImportSegments" class="fileupload">
        <fieldset>
            <legend>Upload your Network File</legend>
            <input type="file" name="File Upload" id="txtFileUpload" />
        </fieldset>
    </div>
</div>
<div id="cy">
</div>
</body>
<script type="application/javascript">

    Array.prototype.getUnique = function(){
        var u = {}, a = [];
        for(var i = 0, l = this.length; i < l; ++i){
            if(u.hasOwnProperty(this[i])) {
                continue;
            }
            a.push(this[i]);
            u[this[i]] = 1;
        }
        return a;
    }

    var body = d3.select('body');

    var numberOfEncodings = 5;
    var numberOfTasks = 5;
    var tasks;
    var encodings;
    var Robj;
    var encs = ['background-color', 'width', 'line-color', 'line-style'];

    function updateTableDimensions() {
        numberOfEncodings = parseInt($("#numEncodings").val());
        numberOfTasks = parseInt($("#numTasks").val());
        console.log(numberOfEncodings);
        console.log(numberOfTasks);
        createTable(numberOfEncodings,numberOfTasks);
        for (var i = 0; i < encs.length; i++) {
            d3.select('.enc'+(i+1)).text(encs[i]);
        }
    }

    function createTable(numberOfEncodings,numberOfTasks) {
        $('#rankTable').remove();
        tasks = makeTasks(numberOfTasks);
        encodings = makeEncodings(numberOfEncodings);
        console.log(encodings);
        console.log(tasks);
        var tabl = makeTable(encodings.length,tasks.length);
    }


    function makeTable(nr,nc) {
        var table = body.append("table")
                .attr("id", "rankTable");
        var trData = [];

        d3.range(0,nr+1).forEach(function(r) {
            var tr = table.append("tr");
            var tdData = [];
            d3.range(0,nc+1).forEach(function(c) {
                var td = tr.append("td")
                        .attr('contenteditable', 'true')
                        .text(function() {
                            if(r === 0) {
                                return tasks[c-1];
                            }
                            if(c === 0) {
                                return encodings[r-1];
                            }
                            return "("+r+","+c+")";
                        })
                        .attr("id", function() {
                            if(r === 0) {
                                return tasks[c-1];
                            }
                            if(c === 0) {
                                return encodings[r-1];
                            }
                            return "cell_row"+r+"_col"+c;
                        })
                        .attr("class", function() {
                            if(r === 0) {
                                return tasks[c-1];
                            }
                            if(c === 0) {
                                return encodings[r-1];
                            }
                            return "rankedcell row"+r+" col"+c;
                        });;
                tdData.push(td);
            });
            trData.push(tr);
        });
        return(trData);
    }

    function randomRanks() {
        for (var i = 1; i < numberOfTasks+1; i++) {
            console.log(numberOfEncodings);
            var ranks = generateArrayofValues(numberOfEncodings);
            console.log(ranks);
            d3.selectAll(".col"+i)
                    .data(ranks)
                    .text(function(d) {
                        return d;
                    });
        }


        function generateArrayofValues(nrows) {
            var arr = [];
            d3.range(1,nrows+1).forEach(function(k) {
                arr.push(getRandomIntInclusive(1,nrows));
            });
            return shuffle(arr);
        }

        function getRandomIntInclusive(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function shuffle(array) {
            var currentIndex = array.length, temporaryValue, randomIndex;

            // While there remain elements to shuffle...
            while (0 !== currentIndex) {

                // Pick a remaining element...
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex -= 1;

                // And swap it with the current element.
                temporaryValue = array[currentIndex];
                array[currentIndex] = array[randomIndex];
                array[randomIndex] = temporaryValue;
            }

            return array;
        }

    }

    function sendToR() {
        var jsontable = rankTableToJSON();
        console.log(jsontable);


        return $.ajax({
            type: 'POST',
            url: 'lp',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify(jsontable),
            success: function (data) {
                console.log(data);
                Robj = data;
                highlightAssignedCells();
                return data;
            }
        });
    }



    function rankTableToJSON() {
        return $('table#rankTable tr').get().map(function(row) {
            return $(row).find('td').get().map(function(cell) {
                return $(cell).html();
            });
        });
    }

    function makeTasks(amount) {
        return d3.range(1,amount+1).map(function(a) {
            return "task"+a;
        });
    }

    function makeEncodings(amount) {
        return d3.range(1,amount+1).map(function(a) {
            return "enc"+a;
        });
    }

    function highlightAssignedCells() {
        d3.selectAll('.rankedcell').attr('bgcolor', null);
        var assignments = Robj;
        var numcols = Object.keys(Robj).length;
        for (var i = 0; i < numcols; i++) {
            var row = assignments[Object.keys(Robj)[i]].indexOf(1);
            var cellAssignment = d3.selectAll('.col'+(i+1))
                                   .filter('.row'+(row+1))
                                   .attr('bgcolor', "#F3F315");
        }
    }

    function plotNetwork() {
//        var cy = cytoscape({
//            container: document.getElementById('cy'),
//            elements: [
//                { data: { id: 'a' } },
//                { data: { id: 'b' } },
//                {
//                    data: {
//                        id: 'ab',
//                        source: 'a',
//                        target: 'b'
//                    }
//                }]
//        });

        var cyCanvas = d3.selectAll('#cy')
                .style('display', 'inline');
        var cy = cytoscape(makeRandomNetwork());
        var options = {
            name: 'random',

            fit: true, // whether to fit to viewport
            padding: 30, // fit padding
            boundingBox: undefined, // constrain layout bounds; { x1, y1, x2, y2 } or { x1, y1, w, h }
            animate: false, // whether to transition the node positions
            animationDuration: 500, // duration of animation in ms if enabled
            animationEasing: undefined, // easing of animation if enabled
            ready: undefined, // callback on layoutready
            stop: undefined // callback on layoutstop
        };

        cy.layout( options );
    }

    function generateStyle() {
        var style = [
            {
                selector: 'node',
                style: {
                    'background-color': 'red',
                    'shape': null, //rectangle, roundrectangle, ellipse, triangle, pentagon, hexagon, heptagon, octagon, star, diamond, vee, rhomboid, or polygon
                    'width': null,
                    'height': null
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 5,
                    'line-color':'blue',
                    'line-style': 'dotted'   //solid, dotted, or dashed
                }
            }
        ];
        return style;
    }

    function makeRandomNetwork() {
        var nodes = d3.range(0,100).map(function(d) {
            return { data: {
                id: d.toString()
            } };
        });
        var edges = d3.range(101,150).map(function(d) {
            return { data: {
                id: d.toString(),
                source: Math.floor(Math.random()*100).toString(),
                target: Math.floor(Math.random()*100).toString()
            } };
        });
        var data = [];
        for (var i = 0; i < nodes.length; i++) {
            data.push(nodes[i]);
        }
        for (var i = 0; i < edges.length; i++) {
            data.push(edges[i]);
        }
        console.log(data);
        return {
            container : document.getElementById('cy'),
            elements: data,
            style: generateStyle()
        };
    }


    function whichHighlight() {
        var items = [];
        d3.selectAll('.rankedcell').each(function(k){
            var it = d3.select(this);
            var high = it.attr('bgcolor');
            var reg = /row\d/g;
            console.log(high);
            if (high !== null) {
                var row = it.attr('class').match(reg);
                items.push(row[0]);
            }
        });
        return items.getUnique();
    }




</script>
</html>